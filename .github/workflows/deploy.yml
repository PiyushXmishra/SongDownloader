name: Build and Deploy to Docker Hub
'on':
  push:
    branches:
      - main
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Repo
        uses: actions/checkout@v2
      - name: Log in to Docker Hub
        uses: docker/login-action@v1
        with:
          username: '${{ secrets.DOCKER_USERNAME }}'
          password: '${{ secrets.DOCKER_PASSWORD }}'
      - name: Prepare Dockerfile for Backend
        run: cp ./backend/Dockerfile ./Dockerfile
      - name: Build and Push Backend Docker image
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: 'piyushm1501/backend:latest'
      - name: Prepare Dockerfile for Frontend
        run: cp ./frontend/Dockerfile ./Dockerfile
      - name: Build and Push Frontend Docker image
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./Dockerfile
          build-args:
            NEXT_PUBLIC_BACKEND_URL: 'http://34.27.210.129:4000'
          push: true
          tags: 'piyushm1501/frontend:latest'
      - name: Verify Pushed Images
        run: |
          docker pull piyushm1501/backend:latest
          docker pull piyushm1501/frontend:latest
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: '${{ secrets.SSH_HOST }}'
          username: '${{ secrets.SSH_USERNAME }}'
          key: '${{ secrets.SSH_KEY }}'
          script: >
            echo "${{ secrets.SECRET_JSON_BASE64 }}" | base64 -d > secret.json


            export PROJECT_ID=${{ secrets.PROJECT_ID }}

            export KEYFILENAME=${{ secrets.KEYFILENAME }}

            export BUCKET_NAME=${{ secrets.BUCKET_NAME }}


            sudo docker pull piyushm1501/backend:latest

            sudo docker stop backend || true

            sudo docker rm backend || true

            sudo docker run -d --network=host --name backend -p 4000:4000 \
              -e PROJECT_ID=${PROJECT_ID} \
              -e KEYFILENAME=${KEYFILENAME} \
              -e BUCKET_NAME=${BUCKET_NAME} \
              -v $(pwd)/secret.json:/app/secret.json \
              piyushm1501/backend:latest

            sudo docker pull piyushm1501/frontend:latest

            sudo docker stop frontend || true

            sudo docker rm frontend || true

            sudo docker run -d --network=host --name frontend -p 3000:3000
            piyushm1501/frontend:latest
